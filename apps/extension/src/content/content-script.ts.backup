// Content Script - Injeta overlay no Google Meet

console.log('üé® Sales Mentor Content Script carregado');

// Injetar CSS inline (evita problemas de build)
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  #sales-mentor-overlay #transcript::-webkit-scrollbar {
    width: 6px;
  }

  #sales-mentor-overlay #transcript::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }

  #sales-mentor-overlay #transcript::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
  }

  #sales-mentor-overlay #transcript::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
`;
document.head.appendChild(style);

// Vari√°vel para guardar se j√° temos permiss√£o
let micPermissionGranted = false;
let micStream: MediaStream | null = null;

// Fun√ß√£o para solicitar permiss√£o de microfone
async function requestMicPermission(): Promise<boolean> {
  try {
    console.log('üé§ Solicitando permiss√£o de microfone...');

    micStream = await navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: true
      }
    });

    console.log('‚úÖ Permiss√£o de microfone concedida');
    micPermissionGranted = true;

    // N√ÉO parar o stream - vamos pass√°-lo para o offscreen
    return true;
  } catch (err: any) {
    console.error('‚ùå Erro ao solicitar permiss√£o:', err);
    micPermissionGranted = false;
    return false;
  }
}

// Criar overlay
function createOverlay() {
  const overlay = document.createElement('div');
  overlay.id = 'sales-mentor-overlay';
  overlay.innerHTML = `
    <div style="
      position: fixed;
      top: 20px;
      right: 20px;
      width: 400px;
      max-height: 80vh;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      padding: 20px;
      z-index: 999999;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    ">
      <h3 style="margin: 0 0 16px 0; color: #1f2937;">
        üéØ Sales Mentor
      </h3>
      <div id="status" style="
        padding: 12px;
        background: #f3f4f6;
        border-radius: 8px;
        margin-bottom: 12px;
        font-size: 14px;
        color: #6b7280;
      ">
        Aguardando in√≠cio da call...
      </div>
      <div id="transcript" style="
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 12px;
        font-size: 13px;
        color: #374151;
      ">
        <!-- Transcri√ß√£o aparecer√° aqui -->
      </div>
      <div id="insights" style="
        font-size: 13px;
      ">
        <!-- Insights aparecer√£o aqui -->
      </div>
    </div>
  `;

  document.body.appendChild(overlay);
  console.log('‚úÖ Overlay injetado no Meet');
}

// Aguardar p√°gina carregar completamente
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', createOverlay);
} else {
  createOverlay();
}

// Escutar mensagens do service worker
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  console.log('üì® Content script recebeu:', message.type);

  const statusEl = document.getElementById('status');

  switch (message.type) {
    case 'REQUEST_MIC_PERMISSION':
      // Solicitar permiss√£o aqui (contexto da p√°gina)
      requestMicPermission().then((granted) => {
        if (granted) {
          if (statusEl) {
            statusEl.textContent = '‚úÖ Microfone autorizado';
            statusEl.style.background = '#d1fae5';
            statusEl.style.color = '#065f46';
          }
          sendResponse({ granted: true });
        } else {
          if (statusEl) {
            statusEl.innerHTML = `
              ‚ö†Ô∏è Permiss√£o de microfone negada<br>
              <small style="font-size: 11px;">
                Clique no √≠cone üîí na barra de endere√ßo<br>
                e permita o acesso ao microfone
              </small>
            `;
            statusEl.style.background = '#fee2e2';
            statusEl.style.color = '#991b1b';
          }
          sendResponse({ granted: false });
        }
      });
      return true; // Manter canal aberto para resposta async

    case 'CALL_STARTED':
      if (statusEl) {
        statusEl.textContent = `‚úÖ Call ativa: ${message.call_id}`;
        statusEl.style.background = '#d1fae5';
        statusEl.style.color = '#065f46';
      }
      sendResponse({ received: true });
      break;

    case 'SHOW_TRANSCRIPT':
      addTranscript(message.data);
      sendResponse({ received: true });
      break;

    case 'SHOW_INSIGHT':
      addInsight(message.data);
      sendResponse({ received: true});
      break;
  }

  return true;
});

function addTranscript(data: any) {
  const transcriptEl = document.getElementById('transcript');
  if (!transcriptEl) return;

  const item = document.createElement('div');
  item.style.cssText = `
    padding: 8px;
    margin-bottom: 8px;
    border-left: 3px solid ${data.speaker === 'CLIENTE' ? '#3b82f6' : '#9ca3af'};
    background: ${data.speaker === 'CLIENTE' ? '#eff6ff' : '#f9fafb'};
    border-radius: 4px;
  `;
  item.innerHTML = `
    <strong style="font-size: 11px; color: #6b7280; text-transform: uppercase;">
      ${data.speaker}
    </strong>
    <div style="margin-top: 4px;">${data.text}</div>
  `;

  transcriptEl.appendChild(item);
  transcriptEl.scrollTop = transcriptEl.scrollHeight;
}

function addInsight(data: any) {
  const insightsEl = document.getElementById('insights');
  if (!insightsEl) return;

  const card = document.createElement('div');
  card.style.cssText = `
    padding: 12px;
    margin-bottom: 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    animation: slideIn 0.3s ease-out;
  `;
  card.innerHTML = `
    <div style="font-weight: 600; margin-bottom: 8px;">
      üí° ${data.title}
    </div>
    <div style="font-size: 12px; opacity: 0.9;">
      ${data.suggestions.map((s: string) => `‚Ä¢ ${s}`).join('<br>')}
    </div>
  `;

  insightsEl.insertBefore(card, insightsEl.firstChild);
}
